<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrievanceForum</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/08c3f952c9.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat&family=Quicksand:wght@600&display=swap');
        body{
            background-color:white;
            font-family: 'Montserrat', sans-serif;
            font-family: 'Quicksand', sans-serif;
        }
        @media (min-width:100px)  { }
        @media (min-width:600px)  { }
        @media (min-width:1281px) { }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="../">
                    <i class="fa-regular fa-snowflake d-inline-block "></i>
                    GrievanceForum
                </a>
                <button class="btn btn-sm btn-outline-primary rounded-pill" style="width:140px">
                    <img src="<%=userInfo['picture']%>" class="rounded-circle" style="width:30%;"/>
                    <%=userInfo["name"]%>
                </button>
            </div>
        </nav><br>
        <%if(userInfo.isadmin == 0){%>
        <nav class="navbar fixed-bottom bg-light">
            <div class="container-fluid">
                <div class="row w-100 text-center">
                    <div class="col">
                        <a href="../dashboard" type="button" class="btn btn-link"> <i class="fa-solid fa-house"></i></a>
                    </div>
                    <div class="col">
                        <a href="../manage" type="button" class="btn btn-link"> <i class="fa-solid fa-plus"></i></a>
                    </div>
                    <div class="col">
                        <a href="../notification" type="button" class="btn btn-link"> <i class="fa-solid fa-bell"></i></a>
                    </div>
                    <div class="col">
                        <a href="../profile" type="button" class="btn btn-link"> <i class="fa-solid fa-user"></i></a>
                    </div>
                </div>
            </div>
        </nav>
        <%}else{%>
        <nav class="navbar fixed-bottom bg-light">
            <div class="container-fluid">
                <a href="../dashboard" type="button" class="btn btn-sm btn-secondary"> <i class="fa-solid fa-house"></i> Go Back</a> 
            </div>
        </nav>
        <%}%>
        <%if(userInfo.isadmin == 1){%>
        <div class="card text-bg-light">
            <div class="card-body">
                <p class="fs-4">Admin Access</p>
                <div class="adminTools">
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#staticSolvePost" <%if(solution.length != 0){%>disabled<%}%>> <i class="fa-regular fa-square-check"></i> <%if(solution.length == 0){%>Solve Post<%}else{%>Solved<%}%></button>
                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#staticDeleteRealPost" > <i class="fa-regular fa-square-minus"></i> Remove Post</button>
                    <div class="vr"></div>
                    <a href="../edit/<%=postInfo.id%>" type="button" class="btn btn-sm btn-primary"> <i class="fa-regular fa-pen-to-square"></i> Edit Post</a>
                </div>
            </div>
        </div><br>
        <%}%>
        <div class="post">
            <p class="fs-2"><%=postInfo.title%></p>
            <p class="text-muted"><%=postInfo.description%></p>
            <hr>
            <div class="text-muted" style="font-size:13px;">
                <div class="row">
                    <div class="col">Created On: <span style="color:black"><%=postInfo.datetime%></span></div>
                    <div class="col">Viewed: <span style="color:black"><%=postInfo.views%> times</span></div>
                </div>
            </div>
            <br>
            <div id="reportMarkdown">
                <%-report%>
            </div>
            <% if(userInfo.isadmin == 0){%>
            <% if(postInfo.support == 1){%>
            <div>
                <div class="row d-flex align-items-center justify-content-center">
                    <div class="col-4">
                        <button id="supportBtn" onclick="supportPost()" class="btn btn-large btn<%if(isSupporting == 0){%>-outline<%}%>-success"><i class="fa-solid fa-hand-sparkles"></i> <%if(isSupporting == 0){%>Support This Post<%}else{%>Currently Supporting<%}%></button>
                    </div>
                    <div class="col-7 text-align-start text-muted">
                        This Post Is Supported By <%=postInfo.likes%> Students
                    </div>
                </div>
            </div>
            <%}}else{%>
                <% if(postInfo.support == 1){%>
                <div class="col-7 text-align-start text-muted">
                    This Post Is Supported By <%=postInfo.likes%> Students
                </div>
            <%}}%>
            <hr>
            <div>
                <a href="" class="btn btn-sm btn-outline-secondary">
                    <div class="row">
                        <div class="col-1">
                            <img src="<%if(userInfo.isadmin || postInfo.anonymous != 1){%><%=postInfo.picture%><%}else{%>../images/anonymous.webp<%}%>" class="rounded-circle" style="width:20px"/>
                        </div>
                        <div class="col-9 text-align-start"><%if(userInfo.isadmin || postInfo.anonymous != 1){%><%=postInfo.name%><%}else{%>Anonymous<%}%></div>
                    </div>
                </a>
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button data-bs-toggle="modal" data-bs-target="#ShareModal" type="button" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-arrow-up-right-from-square"></i> Share</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary"><i class="fa-regular fa-bookmark"></i> Bookmark</button>
                </div>
                <%if(userInfo.isadmin == 0){%>
                <%if(userInfo.mail == postInfo.mail && postInfo.status != 1){%>
                <a href="<%if(postInfo.status == 1){%>javascript:void(0)<%}else{%>../edit/<%=postInfo.id%><%}%>" class="btn btn-sm btn-primary"><i class="fa-solid fa-pen"></i> Edit Post</a>
                <%}}%>
            </div><br>
            <%if(solution.length != 0){%>
            <div>
                <div class="card text-bg-success mb-3">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-5">Solution</div>
                            <div class="col-7 d-flex justify-content-end align-items-center">
                                <span style="margin-right:10px;">Solved By</span>
                                <a href="" class="btn btn-sm btn-light" style="border:0;">
                                    <div class="row">
                                        <div class="col-2">
                                            <img src="<%=solution[0].picture%>" class="rounded-circle" style="width:20px"/>
                                        </div>
                                        <div class="col-9 text-align-start"><%=solution[0].name%></div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                      <p class="card-text"><%=solution[0].message%></p>
                    </div>
                </div>
            </div>
            <%}%>
            <br>
            <div class="comment">
                <p class="fs-3 text-muted">Comments</p>
                <% if(postInfo.comment == 1){%>
                <% if(userInfo.isadmin == 0){%>
                <div class="mb-3">
                    <label for="CommentArea" class="form-label">Post Your Comment</label>
                    <textarea class="form-control" id="CommentArea" rows="2"></textarea>
                    <br>
                    <div class="d-flex align-items-end justify-content-end">
                        <button class="btn btn-sm btn-primary" id="postComment">Post Comment</button>
                    </div>
                </div>
                <br>
                <%}%>
                <%for(let i = 0; i < comments.length; i++){%>
                    <div class="card" style="margin-top:5px;">
                        <div class="card-body">
                            <div class="d-flex text-muted">
                                <a href="" class="btn btn-sm btn-outline-secondary" style="border:0;">
                                    <div class="row">
                                        <div class="col-1">
                                            <img src="<%=comments[i].picture%>" class="rounded-circle" style="width:20px"/>
                                        </div>
                                        <div class="col-9 text-align-start"><%=comments[i].name%></div>
                                    </div>
                                </a>• <%=comments[i].datetime%>
                            </div>

                            <p class="card-text"><%=comments[i].message%></p>
                            <% if(comments[i].mail == userInfo['mail']){ %>
                                <hr>
                                <button class="btn btn-sm btn-primary" onclick="editComment(<%=comments[i].sno%>,`<%=comments[i].message%>`)"><i class="fa-solid fa-pen"></i> Edit Comment</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteComment(<%=comments[i].sno%>,`<%=comments[i].message%>`)"><i class="fa-regular fa-trash-can"></i> Delete Comment</button>
                            <%}%>
                        </div>
                    </div>
                <%}%>
                <%}else{%><p class="text-muted text-align-center"><i class="fa-regular fa-circle-xmark"></i> User Have Disabled The Comments!</p><%}%>
            </div>
        </div>
        <br><br><br>
    </div>

    <div class="modal fade" id="ShareModal" tabindex="-1" aria-labelledby="ShareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="ShareModalLabel">Share The Post</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Post Link" aria-label="Recipient's username" aria-describedby="button-addon2" readonly>
                        <button class="btn btn-light" type="button" id="button-addon2">Copy</button>
                    </div>
                    <hr>
                    <div class="card" style="border:0;overflow:hidden;">
                        <div class="d-flex" style="overflow-x:scroll;margin-left:10px;font-size:50px;">
                            <a href="https://api.whatsapp.com/send?text=CheckOut This Post In The GrievanceForum! {URL_HERE}" data-action="share/whatsapp/share"  target="_blank">
                                <i class="fa-brands fa-whatsapp text-muted"></i>
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=link_to_be_shared" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-facebook text-muted"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?text=CheckOut This Post In The GrievanceForum&url=https://google.com" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-twitter text-muted"></i>
                            </a>
                            <a href="MAILTO:" style="margin-left:20px;" target="_blank">
                                <i class="fa-solid fa-envelope text-muted"></i>
                            </a>
                            <a href="http://www.reddit.com/submit?url=url_here&title=CheckOut This Post In The GrievanceForum" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-reddit text-muted"></i>
                            </a>
                            <a href="whatsapp://send?text=The text to share!" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-pinterest text-muted"></i>
                            </a>
                            <a href="whatsapp://send?text=The text to share!" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-linkedin text-muted"></i>
                            </a>
                            <a href="whatsapp://send?text=The text to share!" style="margin-left:20px;" target="_blank">
                                <i class="fa-brands fa-blogger text-muted"></i>
                            </a>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast align-items-center text-bg-danger border-0" style="position: fixed;left: 1%;bottom: 10%;width: 98%;" role="alert" aria-live="assertive" aria-atomic="true" id="ErrorPostToast">
        <div class="d-flex">
            <div class="toast-body">Invalid Comment ( Write Something... )</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div class="modal fade" id="staticDeleteBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticDeleteBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticDeleteBackdropLabel"><i class="fa-regular fa-trash-can"></i> Delete Comment</h1>
            </div>
            <div class="modal-body">
                <div id="DeleteLoaderText" style="opacity: 1;transition: opacity 0.3s linear;">
                    Once The Comment Is Deleted, The Comment Can't Be Recovered. To Delete This Comment Click The <code>Delete</code> Button Below.
                </div>
    
                <input type="text" class="form-control" id="DeleteId" style="visibility:hidden;" disabled>
                
                <div id="ExtraTitleDesc" style="overflow:hidden;height:100px;transition: all ease-in-out 0.2s;">
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" id="Deletedescription" disabled>
                    </div>
                </div>
                <div id="DeleteLoader" class="d-flex justify-content-center" style="position:relative;bottom:20px;opacity: 0;transition: opacity 0.3s linear;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div style="position:relative;left:155px;visibility:hidden;" id="DeleteOkContainer">
                    <a href="../post/<%=postInfo.id%>" type="submit" class="btn btn-success" >Ok</a>
                </div>
                <div id="DeleteTwoBtnContainer">
                    <button type="button" class="btn btn-secondary" id="DeleteDismiss" data-bs-dismiss="modal">Dismiss</button>
                    <button type="button" class="btn btn-danger" id="DeletePost">Delete</button>
                </div>
            </div>
          </div>
        </div>
    </div>

    <div class="modal fade" id="staticEditBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticEditBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticEditBackdropLabel"><i class="fa-regular fa-trash-can"></i> Edit Comment</h1>
            </div>
            <div class="modal-body">
                <div id="EditLoaderText" style="opacity: 1;transition: opacity 0.3s linear;"></div>
                <input type="text" class="form-control" id="EditId" style="visibility:hidden;position:absolute" disabled>
                <div id="ExtraEditTitleDesc" style="overflow:hidden;transition: all ease-in-out 0.2s;">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="Editdescription" rows="2"></textarea>
                    </div>
                </div>
                <div id="EditLoader" class="d-flex justify-content-center" style="position:relative;bottom:20px;opacity: 0;transition: opacity 0.3s linear;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div style="position:relative;left:155px;visibility:hidden;" id="EditOkContainer">
                    <a href="../post/<%=postInfo.id%>" type="submit" class="btn btn-success" >Ok</a>
                </div>
                <div id="EditTwoBtnContainer">
                    <button type="button" class="btn btn-secondary" id="EditDismiss" data-bs-dismiss="modal">Dismiss</button>
                    <button type="button" class="btn btn-primary" id="EditPost">Edit</button>
                </div>
            </div>
          </div>
        </div>
    </div>
    <%if(userInfo.isadmin == 1){%>
    <div class="modal fade" id="staticSolvePost" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticSolvePostLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="staticBackdropLabel">Solve Post</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="solutionTextArea" class="form-label">Solution</label>
                    <textarea class="form-control" id="solutionTextArea" rows="12"></textarea>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
              <button type="button" id="postSolution" class="btn btn-success">Solve Post</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal fade" id="staticDeleteRealPost" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticDeleteRealPostLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="staticBackdropLabel"><i class="fa-solid fa-trash-can"></i> Delete Post</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <code>Beware:</code> Once The Post Is Deleted You Can't Be Able To Recover It!
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-danger" id="deleteRealPost">Delete Post</button>
            </div>
          </div>
        </div>
    </div>
    <%}%>
<script>
    $("#deleteRealPost").click(function(){
        $.post("/post",{
            deletePost:true,
            id:"<%=postInfo.id%>",
        },
        function (data, status){
            location.reload();
        });
    });

    $("#postSolution").click(function(){
        if($("#solutionTextArea").val().trim().replace('`','') == ""){
            $("#ErrorPostToast").toast("show");
            return;
        }
        document.getElementById("solutionTextArea").removeAttribute("disabled");
        document.getElementById("postSolution").removeAttribute("disabled");

        $.post("/post",{
            postSolution:true,
            id:"<%=postInfo.id%>",
            message:$("#solutionTextArea").val().replace('`','')
        },
        function (data, status){
            document.getElementById("solutionTextArea").removeAttribute("disabled");
            document.getElementById("postSolution").removeAttribute("disabled");
            $("#solutionTextArea").val("");
            location.reload();
        });
    });

    $("#postComment").click(function(){
        if($("#CommentArea").val().trim().replace('`','') == ""){
            $("#ErrorPostToast").toast("show");
            return;
        }

        document.getElementById("CommentArea").setAttribute("disabled","disabled");
        document.getElementById("postComment").setAttribute("disabled","disabled");

        $.post("/post",{
            postComment:true,
            id:"<%=postInfo.id%>",
            message:$("#CommentArea").val().replace('`','')
        },
        function (data, status){
            document.getElementById("CommentArea").removeAttribute("disabled");
            document.getElementById("postComment").removeAttribute("disabled");
            $("#CommentArea").val("");
            location.reload();
        });
    });

    function supportPost(){
        document.getElementById("supportBtn").setAttribute("disabled", "disabled");
        $("#supportBtn").html('<div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>');
        
        $.post("/post",{
            supportPost:true,
            id:"<%=postInfo.id%>",
        },
        function(data, status){
            document.getElementById("supportBtn").removeAttribute("disabled");
            if(data == 0){
                $("#supportBtn").attr('class', 'btn btn-large btn-outline-success');
                $("#supportBtn").html('<i class="fa-solid fa-hand-sparkles"></i> Support The Post');
            }else{
                $("#supportBtn").attr('class', 'btn btn-large btn-success');
                $("#supportBtn").html('<i class="fa-solid fa-hand-sparkles"></i> Currently Supporting');
            }
        });
    }

    function editComment(CommentId,message){
        $("#EditId").val(CommentId);
        $("#Editdescription").val(message);
        $('#staticEditBackdrop').modal('show');
    }

    $("#EditPost").click(function(){
        if($("#Editdescription").val().trim().replace('`','') == ""){
            $("#ErrorPostToast").toast("show");
            $('#staticEditBackdrop').modal('hide');
            return;
        }

        $("#EditDismiss").prop('disabled', true);
        $("#ExtraEditTitleDesc").css("opacity","0");
        $("#EditLoader").css("opacity","1");
        $.post("/post",{
            editComment:true,
            id:$("#EditId").val(),
            message:$("#Editdescription").val().replace('`','')
        },
        function(data, status){
            $("#EditLoaderText").html("<i class='fa-regular fa-circle-check'></i> Comment Changed Successfully!");
            $("#EditLoaderText").css("opacity","1");
            $("#EditLoader").css("opacity","0");
            $("#EditTwoBtnContainer").css("visibility","hidden");
            $("#EditOkContainer").css("visibility","visible");
        });
    });

    function deleteComment(CommentId,message){
        $("#DeleteId").val(CommentId);
        $("#Deletedescription").val(message);
        $('#staticDeleteBackdrop').modal('show');
    }

    $("#DeletePost").click(function(){
        $("#DeleteDismiss").prop('disabled', true);
        $("#DeleteLoaderText").css("opacity","0");
        $("#DeleteLoader").css("opacity","1");
        $.post("/post",{
            deleteComment:true,
            id:$("#DeleteId").val(),
            Postid:"<%=postInfo.id%>"
        },
        function(data, status){
            $("#ExtraTitleDesc").css("height","0px");
            $("#DeleteLoaderText").html("<i class='fa-regular fa-circle-check'></i> Comment Deleted Successfully!");
            $("#DeleteLoaderText").css("opacity","1");
            $("#DeleteLoader").css("opacity","0");
            $("#DeleteTwoBtnContainer").css("visibility","hidden");
            $("#DeleteOkContainer").css("visibility","visible");
        });
    });
</script>
</body>
</html>